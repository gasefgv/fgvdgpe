<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa por DRE — Gestão para a Aprendizagem</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --azul-escuro: #0b5fa5;
            --azul-medio: #1e90ff;
            --azul-claro: #4da6ff;
            --azul-pastel: #f1f9ff;
            --cinza-texto: #666666;
            --branco: #FFFFFF;
            --sombra-suave: 0 4px 15px rgba(11, 95, 165, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: 'Source Sans Pro', sans-serif; background-color: var(--azul-pastel); color: var(--cinza-texto); }

        .app-container { display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%); padding: 0.75rem 1.5rem; box-shadow: var(--sombra-suave); z-index: 1000; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .btn-voltar { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--branco); text-decoration: none; font-size: 0.9rem; padding: 0.5rem 1rem; border-radius: 8px; background: rgba(255,255,255,0.1); transition: background 0.3s; }
        .btn-voltar:hover { background: rgba(255,255,255,0.2); color: var(--branco); }
        .logo { height: 45px; }
        .header-center { text-align: center; flex: 1; }
        .header-title { color: var(--branco); font-size: 1.35rem; font-weight: 700; margin: 0; }
        .header-subtitle { color: rgba(255,255,255,0.8); font-size: 0.85rem; }
        .header-right { display: flex; gap: 0.75rem; }
        .btn-export { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--branco); color: var(--azul-escuro); padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-export:hover { transform: scale(1.03); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* CONTEÚDO */
        .content-area { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--branco); border-right: 1px solid rgba(11,95,165,0.1); padding: 1.25rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        .filter-section { background: var(--azul-pastel); border-radius: 12px; padding: 1rem; }
        .filter-title { color: var(--azul-escuro); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem; }
        .filter-icon { width: 16px; height: 16px; opacity: 0.8; }
        .filter-select { width: 100%; padding: 0.6rem 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; background: var(--branco); cursor: pointer; }
        .filter-select:focus { border-color: var(--azul-medio); outline: none; }

        .summary-panel { background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%); border-radius: 12px; padding: 1rem; color: var(--branco); }
        .summary-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; margin-bottom: 0.6rem; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
        .summary-item { text-align: center; }
        .summary-value { font-size: 1.4rem; font-weight: 700; }
        .summary-label { font-size: 0.7rem; opacity: 0.85; }

        .current-indicator { background: var(--branco); border: 2px solid var(--azul-claro); border-radius: 12px; padding: 0.75rem; text-align: center; }
        .current-indicator-label { font-size: 0.7rem; color: var(--cinza-texto); text-transform: uppercase; letter-spacing: 0.5px; }
        .current-indicator-value { font-size: 0.95rem; font-weight: 700; color: var(--azul-escuro); margin-top: 0.2rem; }

        /* MAPA + ANÁLISE */
        .map-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .map-container { flex: 1; position: relative; min-height: 350px; }
        #map { width: 100%; height: 100%; }

        /* LEGENDA */
        .legend { position: absolute; bottom: 20px; right: 15px; background: var(--branco); padding: 0.75rem; border-radius: 8px; box-shadow: var(--sombra-suave); z-index: 1000; min-width: 150px; }
        .legend-title { font-size: 0.75rem; font-weight: 600; color: var(--azul-escuro); margin-bottom: 0.5rem; text-transform: uppercase; }
        .legend-scale { display: flex; flex-direction: column; gap: 0.2rem; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; }
        .legend-color { width: 20px; height: 14px; border-radius: 2px; }

        /* LABELS DAS DRES */
        .dre-label { 
            background: transparent !important; 
            border: none !important; 
            font-weight: 700; 
            font-size: 10px; 
            color: #084594; 
            text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white, 0 0 4px white; 
            white-space: nowrap;
            text-align: center;
        }

        /* POPUP */
        .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: var(--sombra-suave); }
        .leaflet-popup-content { margin: 0; min-width: 260px; }
        .popup-header { background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%); color: var(--branco); padding: 0.6rem 0.9rem; border-radius: 12px 12px 0 0; margin: -1px -1px 0 -1px; }
        .popup-title { font-size: 0.95rem; font-weight: 700; margin: 0; }
        .popup-subtitle { font-size: 0.75rem; opacity: 0.85; }
        .popup-body { padding: 0.9rem; }
        .popup-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .popup-table th { text-align: left; color: var(--cinza-texto); font-weight: 400; padding: 0.3rem 0; border-bottom: 1px solid #eee; }
        .popup-table td { text-align: right; font-weight: 600; color: var(--azul-escuro); padding: 0.3rem 0; border-bottom: 1px solid #eee; }
        .popup-btn { width: 100%; padding: 0.45rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-align: center; cursor: pointer; background: var(--azul-escuro); color: var(--branco); border: none; margin-top: 0.6rem; }
        .popup-btn:hover { background: var(--azul-medio); }

        /* SEÇÃO DE ANÁLISE */
        .analysis-section { background: var(--branco); border-top: 2px solid var(--azul-claro); padding: 1.25rem; max-height: 45vh; overflow-y: auto; }
        .analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
        .analysis-title { color: var(--azul-escuro); font-size: 1.05rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .analysis-tabs { display: flex; gap: 0.4rem; }
        .tab-btn { padding: 0.45rem 0.9rem; border: 2px solid var(--azul-claro); border-radius: 6px; background: var(--branco); color: var(--azul-escuro); font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.3s; }
        .tab-btn.active, .tab-btn:hover { background: var(--azul-escuro); color: var(--branco); border-color: var(--azul-escuro); }

        .analysis-content { display: flex; gap: 1.25rem; flex-wrap: wrap; }
        .analysis-panel { flex: 1; min-width: 280px; }
        .panel-title { font-size: 0.85rem; font-weight: 600; color: var(--azul-escuro); margin-bottom: 0.6rem; padding-bottom: 0.4rem; border-bottom: 2px solid var(--azul-pastel); }

        /* TABELA DE ESCOLAS */
        .table-scroll { max-height: 220px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .schools-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .schools-table th { background: var(--azul-pastel); color: var(--azul-escuro); padding: 0.5rem 0.4rem; text-align: left; font-weight: 600; position: sticky; top: 0; font-size: 0.75rem; }
        .schools-table td { padding: 0.4rem; border-bottom: 1px solid #eee; }
        .schools-table tr:hover { background: var(--azul-pastel); }
        .schools-table .num { text-align: right; font-weight: 600; color: var(--azul-escuro); }

        /* GRÁFICOS */
        .chart-container { height: 200px; background: var(--azul-pastel); border-radius: 6px; display: flex; align-items: flex-end; justify-content: center; padding: 0.75rem 0.5rem; gap: 0.3rem; overflow-x: auto; }
        .bar-group { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; min-width: 45px; }
        .bars-wrapper { display: flex; gap: 2px; align-items: flex-end; height: 140px; }
        .bar { width: 12px; border-radius: 3px 3px 0 0; transition: height 0.4s; }
        .bar.saeb { background: #084594; }
        .bar.diag { background: #2171b5; }
        .bar.form { background: #6baed6; }
        .bar.saese { background: #4da6ff; }
        .bar-label { font-size: 0.65rem; color: var(--cinza-texto); text-align: center; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .chart-legend { display: flex; justify-content: center; gap: 0.75rem; margin-top: 0.6rem; flex-wrap: wrap; }
        .legend-chip { display: flex; align-items: center; gap: 0.25rem; font-size: 0.7rem; }
        .legend-dot { width: 10px; height: 10px; border-radius: 2px; }

        /* LOADING */
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(241,249,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .loading-spinner { width: 45px; height: 45px; border: 4px solid var(--azul-pastel); border-top-color: var(--azul-escuro); border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-text { margin-top: 0.75rem; color: var(--azul-escuro); font-weight: 600; font-size: 0.9rem; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* RESPONSIVO */
        @media (max-width: 992px) { 
            .content-area { flex-direction: column; } 
            .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; max-height: none; padding: 0.75rem; }
            .filter-section, .summary-panel, .current-indicator { flex: 1; min-width: 200px; }
        }
        @media (max-width: 768px) { 
            .header-center { display: none; } 
            .legend { bottom: 10px; right: 10px; }
            .analysis-content { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <a href="index.html" class="btn-voltar">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        Voltar
                    </a>
                    <img src="assets/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                </div>
                <div class="header-center">
                    <h1 class="header-title">Mapa por Diretoria Regional</h1>
                    <p class="header-subtitle">Indicadores educacionais georreferenciados</p>
                </div>
                <div class="header-right">
                    <button class="btn-export" onclick="exportMap()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        Exportar PNG
                    </button>
                </div>
            </div>
        </header>

        <div class="content-area">
            <aside class="sidebar">
                <div class="filter-section">
                    <h3 class="filter-title">
                        <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v8H3zm4-5h2v13H7zm4-4h2v17h-2zm4 8h2v9h-2zm4-4h2v13h-2z"/></svg>
                        Indicador
                    </h3>
                    <select id="indicatorSelect" class="filter-select" onchange="updateMap()"></select>
                </div>

                <div class="filter-section">
                    <h3 class="filter-title">
                        <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        Diretoria Regional
                    </h3>
                    <select id="dreSelect" class="filter-select" onchange="filterByDRE()">
                        <option value="">Todas as DREs</option>
                    </select>
                </div>

                <div class="current-indicator">
                    <div class="current-indicator-label">Indicador Ativo</div>
                    <div class="current-indicator-value" id="currentIndicatorName">Carregando...</div>
                </div>

                <div class="summary-panel">
                    <h3 class="summary-title">Resumo Geral</h3>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="summary-value" id="totalEscolas">--</div><div class="summary-label">Escolas</div></div>
                        <div class="summary-item"><div class="summary-value" id="totalDREs">10</div><div class="summary-label">DREs</div></div>
                        <div class="summary-item"><div class="summary-value" id="mediaIndicador">--</div><div class="summary-label">Média Geral</div></div>
                        <div class="summary-item"><div class="summary-value" id="totalAlunos">--</div><div class="summary-label">Alunos</div></div>
                    </div>
                </div>
            </aside>

            <div class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                    <div class="legend" id="legend">
                        <div class="legend-title">Legenda</div>
                        <div class="legend-scale" id="legendScale"></div>
                    </div>
                    <div class="loading-overlay" id="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Carregando dados...</div>
                    </div>
                </div>

                <!-- SEÇÃO DE ANÁLISE POR ESCOLA -->
                <div class="analysis-section" id="analysisSection">
                    <div class="analysis-header">
                        <h3 class="analysis-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                            <span id="analysisTitleText">Análise por Escola — Todas as DREs</span>
                        </h3>
                        <div class="analysis-tabs">
                            <button class="tab-btn active" onclick="showTab('participacao', this)">Participação</button>
                            <button class="tab-btn" onclick="showTab('proficiencia', this)">Proficiência</button>
                        </div>
                    </div>

                    <!-- ABA PARTICIPAÇÃO -->
                    <div class="analysis-content" id="tabParticipacao">
                        <div class="analysis-panel">
                            <h4 class="panel-title">Comparativo de Taxas de Participação (Top 10)</h4>
                            <div class="chart-container" id="chartParticipacao"></div>
                            <div class="chart-legend">
                                <div class="legend-chip"><div class="legend-dot" style="background:#084594"></div>SAEB 23</div>
                                <div class="legend-chip"><div class="legend-dot" style="background:#2171b5"></div>Av. Diagnóstica</div>
                                <div class="legend-chip"><div class="legend-dot" style="background:#6baed6"></div>Av. Formativa</div>
                            </div>
                        </div>
                        <div class="analysis-panel">
                            <h4 class="panel-title">Ranking de Escolas por Participação</h4>
                            <div class="table-scroll">
                                <table class="schools-table" id="tableParticipacao">
                                    <thead><tr><th>Escola</th><th>SAEB</th><th>Diag.</th><th>Form.</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ABA PROFICIÊNCIA -->
                    <div class="analysis-content" id="tabProficiencia" style="display:none;">
                        <div class="analysis-panel">
                            <h4 class="panel-title">Comparativo de Proficiência Média (Top 10)</h4>
                            <div class="chart-container" id="chartProficiencia"></div>
                            <div class="chart-legend">
                                <div class="legend-chip"><div class="legend-dot" style="background:#084594"></div>SAEB PT</div>
                                <div class="legend-chip"><div class="legend-dot" style="background:#2171b5"></div>SAEB Mat</div>
                                <div class="legend-chip"><div class="legend-dot" style="background:#4da6ff"></div>SAESE PT</div>
                                <div class="legend-chip"><div class="legend-dot" style="background:#6baed6"></div>SAESE Mat</div>
                            </div>
                        </div>
                        <div class="analysis-panel">
                            <h4 class="panel-title">Ranking de Escolas por Proficiência</h4>
                            <div class="table-scroll">
                                <table class="schools-table" id="tableProficiencia">
                                    <thead><tr><th>Escola</th><th>SAEB PT</th><th>SAEB Mat</th><th>SAESE PT</th><th>SAESE Mat</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // CONFIGURAÇÃO DOS INDICADORES
        const INDICADORES = [
            { id: 'SAEB 23 Taxa Participação', nome: 'SAEB 23 - Taxa de Participação', tipo: 'percentual', agregacao: 'media' },
            { id: 'SAEB 23 Nota Média PT', nome: 'SAEB 23 - Nota Média Port.', tipo: 'numero', agregacao: 'media' },
            { id: 'SAEB 23 Nota Média Mat', nome: 'SAEB 23 - Nota Média Mat.', tipo: 'numero', agregacao: 'media' },
            { id: 'SAESE 24 Proficiência PT', nome: 'SAESE 24 - Proficiência Port.', tipo: 'numero', agregacao: 'media' },
            { id: 'SAESE 24 Proficiência MAT', nome: 'SAESE 24 - Proficiência Mat.', tipo: 'numero', agregacao: 'media' },
            { id: 'Participação Avaliação Diagnóstica', nome: 'Av. Diagnóstica - Participação', tipo: 'percentual', agregacao: 'media' },
            { id: 'Rendimento Médio Língua Portuguesa Avaliação Diagnóstica', nome: 'Av. Diagnóstica - Rend. Port.', tipo: 'percentual', agregacao: 'media' },
            { id: 'Rendimento Médio Matemática Avaliação Diagnóstica', nome: 'Av. Diagnóstica - Rend. Mat.', tipo: 'percentual', agregacao: 'media' },
            { id: 'Número de Alunos', nome: 'Número de Alunos', tipo: 'numero', agregacao: 'soma' },
            { id: 'Participação Avaliação Formativa', nome: 'Av. Formativa - Participação', tipo: 'percentual', agregacao: 'media' },
            { id: 'Rendimento LP Avaliação Formativa', nome: 'Av. Formativa - Rend. Port.', tipo: 'percentual', agregacao: 'media' },
            { id: 'Rendimento MAT Avaliação Formativa', nome: 'Av. Formativa - Rend. Mat.', tipo: 'percentual', agregacao: 'media' }
        ];

        const CORES_CHOROPLETH = ['#f7fbff', '#c6dbef', '#6baed6', '#2171b5', '#084594'];

        // NOMES DAS DRES
        const DRE_NOMES = {
            'DEA': 'DEA',
            'DRE 01': 'DRE 01',
            'DRE 02': 'DRE 02',
            'DRE 03': 'DRE 03',
            'DRE 04': 'DRE 04',
            'DRE 05': 'DRE 05',
            'DRE 06': 'DRE 06',
            'DRE 07': 'DRE 07',
            'DRE 08': 'DRE 08',
            'DRE 09': 'DRE 09'
        };

        let map, geoJsonLayer, labelMarkers = [], dadosCSV = [], geoJsonData = null, dadosAgregados = {};
        let indicadorAtual = INDICADORES[0].id, dreSelecionada = '';

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                preencherDropdownIndicadores();
                await carregarDados();
                inicializarMapa();
                verificarParametroURL();
                atualizarAnalise();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').innerHTML = '<div style="color:#c0392b;text-align:center;padding:20px;"><p><strong>Erro ao carregar dados</strong></p><p>' + error.message + '</p><p style="font-size:0.8rem;margin-top:10px;">Verifique: data/base_tabelar.csv e data/geojs-28-reg.json</p></div>';
            }
        }

        async function carregarDados() {
            const csvResponse = await fetch('data/base_tabelar.csv');
            if (!csvResponse.ok) throw new Error('Arquivo CSV não encontrado');
            dadosCSV = d3.csvParse(await csvResponse.text());
            
            const geoResponse = await fetch('data/geojs-28-reg.json');
            if (!geoResponse.ok) throw new Error('Arquivo GeoJSON não encontrado');
            geoJsonData = await geoResponse.json();
            
            agregarDadosPorDRE();
            preencherDropdownDREs();
            atualizarResumo();
        }

        function agregarDadosPorDRE() {
            dadosAgregados = {};
            const mapearDRE = (dre) => dre === 'DEA' ? 'DEA' : dre.replace(/(\d+)/, ' $1').replace('  ', ' ');
            
            dadosCSV.forEach(escola => {
                const dreMapeada = mapearDRE(escola.DRE);
                if (!dadosAgregados[dreMapeada]) dadosAgregados[dreMapeada] = { dreOriginal: escola.DRE, escolas: [], totalAlunos: 0 };
                dadosAgregados[dreMapeada].escolas.push(escola);
                dadosAgregados[dreMapeada].totalAlunos += parseFloat(escola['Número de Alunos']) || 0;
            });
            
            Object.keys(dadosAgregados).forEach(dre => {
                const escolas = dadosAgregados[dre].escolas;
                INDICADORES.forEach(ind => {
                    const valores = escolas.map(e => parseFloat(e[ind.id])).filter(v => !isNaN(v));
                    dadosAgregados[dre][ind.id] = valores.length > 0 ? (ind.agregacao === 'soma' ? valores.reduce((a,b)=>a+b,0) : valores.reduce((a,b)=>a+b,0)/valores.length) : null;
                });
            });
        }

        function preencherDropdownIndicadores() {
            const select = document.getElementById('indicatorSelect');
            INDICADORES.forEach(ind => { const opt = document.createElement('option'); opt.value = ind.id; opt.textContent = ind.nome; select.appendChild(opt); });
        }

        function preencherDropdownDREs() {
            const select = document.getElementById('dreSelect');
            Object.keys(dadosAgregados).sort().forEach(dre => { const opt = document.createElement('option'); opt.value = dre; opt.textContent = dre; select.appendChild(opt); });
        }

        function inicializarMapa() {
            map = L.map('map').setView([-10.5, -37.4], 8);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap © CARTO', maxZoom: 19 }).addTo(map);
            atualizarCamadaGeoJSON();
        }

        function atualizarCamadaGeoJSON() {
            if (geoJsonLayer) map.removeLayer(geoJsonLayer);
            labelMarkers.forEach(m => map.removeLayer(m)); labelMarkers = [];

            const dres = dreSelecionada ? [dreSelecionada] : Object.keys(dadosAgregados);
            const valores = dres.map(dre => dadosAgregados[dre]?.[indicadorAtual]).filter(v => v !== null && !isNaN(v));
            const minVal = Math.min(...valores), maxVal = Math.max(...valores);

            const obterCor = (valor) => {
                if (valor === null || isNaN(valor)) return '#e0e0e0';
                const norm = (valor - minVal) / (maxVal - minVal || 1);
                return CORES_CHOROPLETH[Math.min(Math.floor(norm * CORES_CHOROPLETH.length), CORES_CHOROPLETH.length - 1)];
            };

            geoJsonLayer = L.geoJSON(geoJsonData, {
                style: (feature) => {
                    const dre = feature.properties.region;
                    const valor = dadosAgregados[dre]?.[indicadorAtual];
                    const visivel = !dreSelecionada || dreSelecionada === dre;
                    return { fillColor: visivel ? obterCor(valor) : '#f0f0f0', weight: 2, opacity: 1, color: visivel ? '#0b5fa5' : '#ccc', fillOpacity: visivel ? 0.75 : 0.3 };
                },
                onEachFeature: (feature, layer) => {
                    const dre = feature.properties.region;
                    layer.bindPopup(criarPopupContent(dre, dadosAgregados[dre]), { maxWidth: 320 });
                    layer.on({ 
                        mouseover: e => { e.target.setStyle({ weight: 3, fillOpacity: 0.9 }); e.target.bringToFront(); }, 
                        mouseout: e => geoJsonLayer.resetStyle(e.target) 
                    });

                    // ADICIONAR LABEL DA DRE
                    const bounds = layer.getBounds();
                    const center = bounds.getCenter();
                    const labelText = DRE_NOMES[dre] || dre;
                    const label = L.marker(center, {
                        icon: L.divIcon({ 
                            className: 'dre-label', 
                            html: '<div>' + labelText + '</div>', 
                            iconSize: [60, 20], 
                            iconAnchor: [30, 10] 
                        }),
                        interactive: false
                    });
                    label.addTo(map);
                    labelMarkers.push(label);
                }
            }).addTo(map);

            atualizarLegenda(minVal, maxVal);
            document.getElementById('currentIndicatorName').textContent = INDICADORES.find(i => i.id === indicadorAtual)?.nome || indicadorAtual;
        }

        function criarPopupContent(dre, dados) {
            if (!dados) return '<div class="popup-header"><h4 class="popup-title">' + dre + '</h4></div><div class="popup-body"><p>Sem dados</p></div>';
            const fmt = (v, t) => (v === null || isNaN(v)) ? '-' : (t === 'percentual' ? (v*100).toFixed(1)+'%' : v.toFixed(2));
            let tbl = '';
            INDICADORES.slice(0,6).forEach(ind => { tbl += '<tr><th>' + ind.nome + '</th><td>' + fmt(dados[ind.id], ind.tipo) + '</td></tr>'; });
            return '<div class="popup-header"><h4 class="popup-title">' + dre + '</h4><span class="popup-subtitle">' + dados.escolas.length + ' escolas | ' + dados.totalAlunos.toLocaleString('pt-BR') + ' alunos</span></div><div class="popup-body"><table class="popup-table">' + tbl + '</table><button class="popup-btn" onclick="baixarCSVDRE(\'' + dre + '\')">Baixar CSV desta DRE</button></div>';
        }

        function atualizarLegenda(minVal, maxVal) {
            const tipo = INDICADORES.find(i => i.id === indicadorAtual)?.tipo || 'numero';
            const fmt = v => tipo === 'percentual' ? (v*100).toFixed(0)+'%' : v.toFixed(1);
            const intervalo = (maxVal - minVal) / CORES_CHOROPLETH.length;
            let html = '';
            for (let i = CORES_CHOROPLETH.length - 1; i >= 0; i--) {
                const vi = minVal + i * intervalo, vf = minVal + (i+1) * intervalo;
                html += '<div class="legend-item"><div class="legend-color" style="background:' + CORES_CHOROPLETH[i] + '"></div><span>' + fmt(vi) + ' - ' + fmt(vf) + '</span></div>';
            }
            html += '<div class="legend-item"><div class="legend-color" style="background:#e0e0e0"></div><span>Sem dados</span></div>';
            document.getElementById('legendScale').innerHTML = html;
        }

        function atualizarResumo() {
            document.getElementById('totalEscolas').textContent = dadosCSV.length;
            const total = dadosCSV.reduce((a,e) => a + (parseFloat(e['Número de Alunos']) || 0), 0);
            document.getElementById('totalAlunos').textContent = total.toLocaleString('pt-BR');
            const vals = Object.values(dadosAgregados).map(d => d[indicadorAtual]).filter(v => v !== null && !isNaN(v));
            if (vals.length > 0) {
                const media = vals.reduce((a,b) => a+b, 0) / vals.length;
                const ind = INDICADORES.find(i => i.id === indicadorAtual);
                document.getElementById('mediaIndicador').textContent = ind?.tipo === 'percentual' ? (media*100).toFixed(1)+'%' : media.toFixed(2);
            }
        }

        function updateMap() {
            indicadorAtual = document.getElementById('indicatorSelect').value;
            atualizarCamadaGeoJSON();
            atualizarResumo();
        }

        function filterByDRE() {
            dreSelecionada = document.getElementById('dreSelect').value;
            if (dreSelecionada) {
                geoJsonLayer.eachLayer(layer => {
                    if (layer.feature?.properties.region === dreSelecionada) map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                });
            } else {
                map.setView([-10.5, -37.4], 8);
            }
            atualizarCamadaGeoJSON();
            atualizarAnalise();
        }

        function verificarParametroURL() {
            const dre = new URLSearchParams(window.location.search).get('dre');
            if (dre) {
                dreSelecionada = dre === 'DEA' ? 'DEA' : dre.replace(/(\d+)/, ' $1').replace('  ', ' ');
                document.getElementById('dreSelect').value = dreSelecionada;
                filterByDRE();
            }
        }

        // ANÁLISE POR ESCOLA
        function showTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tabParticipacao').style.display = tab === 'participacao' ? 'flex' : 'none';
            document.getElementById('tabProficiencia').style.display = tab === 'proficiencia' ? 'flex' : 'none';
        }

        function atualizarAnalise() {
            const escolas = dreSelecionada ? dadosAgregados[dreSelecionada]?.escolas || [] : dadosCSV;
            document.getElementById('analysisTitleText').textContent = dreSelecionada ? 'Análise por Escola — ' + dreSelecionada : 'Análise por Escola — Todas as DREs';
            atualizarParticipacao(escolas);
            atualizarProficiencia(escolas);
        }

        function atualizarParticipacao(escolas) {
            const container = document.getElementById('chartParticipacao');
            const tbody = document.querySelector('#tableParticipacao tbody');

            const sorted = [...escolas].sort((a,b) => (parseFloat(b['SAEB 23 Taxa Participação'])||0) - (parseFloat(a['SAEB 23 Taxa Participação'])||0));
            const top10 = sorted.slice(0, 10);

            let chartHtml = '';
            top10.forEach(e => {
                const saeb = (parseFloat(e['SAEB 23 Taxa Participação']) || 0) * 100;
                const diag = (parseFloat(e['Participação Avaliação Diagnóstica']) || 0) * 100;
                const form = (parseFloat(e['Participação Avaliação Formativa']) || 0) * 100;
                const nome = (e.Escola || '').substring(0, 12);
                chartHtml += '<div class="bar-group"><div class="bars-wrapper"><div class="bar saeb" style="height:' + (saeb*1.4) + 'px" title="SAEB: ' + saeb.toFixed(1) + '%"></div><div class="bar diag" style="height:' + (diag*1.4) + 'px" title="Diag: ' + diag.toFixed(1) + '%"></div><div class="bar form" style="height:' + (form*1.4) + 'px" title="Form: ' + form.toFixed(1) + '%"></div></div><div class="bar-label" title="' + e.Escola + '">' + nome + '</div></div>';
            });
            container.innerHTML = chartHtml;

            let tblHtml = '';
            sorted.slice(0, 20).forEach(e => {
                const saeb = parseFloat(e['SAEB 23 Taxa Participação']);
                const diag = parseFloat(e['Participação Avaliação Diagnóstica']);
                const form = parseFloat(e['Participação Avaliação Formativa']);
                tblHtml += '<tr><td title="' + e.Escola + '">' + (e.Escola||'').substring(0,35) + '</td><td class="num">' + (isNaN(saeb)?'-':(saeb*100).toFixed(1)+'%') + '</td><td class="num">' + (isNaN(diag)?'-':(diag*100).toFixed(1)+'%') + '</td><td class="num">' + (isNaN(form)?'-':(form*100).toFixed(1)+'%') + '</td></tr>';
            });
            tbody.innerHTML = tblHtml;
        }

        function atualizarProficiencia(escolas) {
            const container = document.getElementById('chartProficiencia');
            const tbody = document.querySelector('#tableProficiencia tbody');

            const sorted = [...escolas].sort((a,b) => (parseFloat(b['SAEB 23 Nota Média PT'])||0) - (parseFloat(a['SAEB 23 Nota Média PT'])||0));
            const top10 = sorted.slice(0, 10);
            const maxProf = 320;

            let chartHtml = '';
            top10.forEach(e => {
                const saebPT = parseFloat(e['SAEB 23 Nota Média PT']) || 0;
                const saebMat = parseFloat(e['SAEB 23 Nota Média Mat']) || 0;
                const saesePT = parseFloat(e['SAESE 24 Proficiência PT']) || 0;
                const saeseMat = parseFloat(e['SAESE 24 Proficiência MAT']) || 0;
                const nome = (e.Escola || '').substring(0, 12);
                chartHtml += '<div class="bar-group"><div class="bars-wrapper"><div class="bar saeb" style="height:' + (saebPT/maxProf*140) + 'px" title="SAEB PT: ' + saebPT.toFixed(1) + '"></div><div class="bar diag" style="height:' + (saebMat/maxProf*140) + 'px" title="SAEB Mat: ' + saebMat.toFixed(1) + '"></div><div class="bar saese" style="height:' + (saesePT/maxProf*140) + 'px" title="SAESE PT: ' + saesePT.toFixed(1) + '"></div><div class="bar form" style="height:' + (saeseMat/maxProf*140) + 'px" title="SAESE Mat: ' + saeseMat.toFixed(1) + '"></div></div><div class="bar-label" title="' + e.Escola + '">' + nome + '</div></div>';
            });
            container.innerHTML = chartHtml;

            let tblHtml = '';
            sorted.slice(0, 20).forEach(e => {
                const saebPT = parseFloat(e['SAEB 23 Nota Média PT']);
                const saebMat = parseFloat(e['SAEB 23 Nota Média Mat']);
                const saesePT = parseFloat(e['SAESE 24 Proficiência PT']);
                const saeseMat = parseFloat(e['SAESE 24 Proficiência MAT']);
                tblHtml += '<tr><td title="' + e.Escola + '">' + (e.Escola||'').substring(0,30) + '</td><td class="num">' + (isNaN(saebPT)?'-':saebPT.toFixed(1)) + '</td><td class="num">' + (isNaN(saebMat)?'-':saebMat.toFixed(1)) + '</td><td class="num">' + (isNaN(saesePT)?'-':saesePT.toFixed(1)) + '</td><td class="num">' + (isNaN(saeseMat)?'-':saeseMat.toFixed(1)) + '</td></tr>';
            });
            tbody.innerHTML = tblHtml;
        }

        function exportMap() {
            html2canvas(document.querySelector('.map-container'), { useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a'); link.download = 'mapa_' + indicadorAtual.replace(/\s/g,'_') + '.png'; link.href = canvas.toDataURL(); link.click();
            }).catch(() => alert('Use Ctrl+P → Salvar como PDF'));
        }

        function baixarCSVDRE(dre) {
            const dados = dadosAgregados[dre];
            if (!dados?.escolas) return;
            const headers = Object.keys(dados.escolas[0]);
            let csv = headers.join(';') + '\n';
            dados.escolas.forEach(e => { csv += headers.map(h => { let v = e[h]||''; if (typeof v === 'string' && (v.includes(';')||v.includes('"'))) v = '"'+v.replace(/"/g,'""')+'"'; return v; }).join(';') + '\n'; });
            const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'escolas_' + dre.replace(/\s/g,'_') + '.csv'; link.click();
        }
    </script>
</body>
</html>
